<div class="project-details">
  <h2>プロジェクト詳細</h2>

  <!-- プロジェクト情報 -->
  <div class="project-info">
    <p><strong>顧客名:</strong> <%= @project.customer_name %></p>
    <p><strong>商品名:</strong> <%= @project.product_name %></p>
    <p><strong>表示容量:</strong> <%= @project.display_volume %></p>
    <p><strong>カテゴリー:</strong> <%= @project.category.name %></p>
    <p><strong>出荷日:</strong> <%= @project.shipment_date.strftime("%Y/%m/%d") %></p>
  </div>

  <div class="schedules-container">
    <!-- 全体スケジュールボックス -->
    <div class="schedule-box">
      <h3 class="centered-heading">全体スケジュール</h3>
      <% all_tasks = @project.tasks.where.not("name LIKE ?", "化粧箱 - %").order(:start_date) %>
      <% all_tasks = all_tasks.to_a << Task.new(name: "出荷", start_date: @project.shipment_date) %> <!-- 出荷タスクの追加 -->
      <% all_tasks.group_by { |task| task.start_date.year }.each do |year, tasks| %>
        <h4 class="year-heading"><%= year %>年</h4>
        <table class="task-table">
          <tbody>
            <% tasks.each do |task| %>
              <tr>
                <td><%= task.start_date.strftime("%-m/%-d") %></td>
                <td><%= task.name %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      <div class="lead-time-box">
        <button class="lead-time-toggle">全体スケジュールのリードタイム</button>
        <div class="lead-time-container" style="display: none;">
          <table class="lead-time-table">
            <tbody>
              <tr><td>処方決定 〜 容器試験依頼</td><td>3日</td></tr>
              <tr><td>容器試験依頼 〜 容器試験スタート</td><td>20日</td></tr>
              <tr><td>容器試験スタート 〜 容器試験終了</td><td>40日</td></tr>
              <tr><td>容器試験終了 〜 注文書受領</td><td>7日</td></tr>
              <tr><td>注文書受領 〜 資材発注</td><td>5日</td></tr>
              <tr><td>資材発注 〜 資材納品</td><td>100日</td></tr>
              <tr><td>資材納品 〜 生産</td><td>14日</td></tr>
              <tr><td>生産 〜 出荷</td><td>14日</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 化粧箱スケジュールボックス -->
    <div class="schedule-box">
      <h3 class="centered-heading">化粧箱スケジュール</h3>
      <% box_tasks = @project.tasks.where("name LIKE ?", "化粧箱 - %").order(:start_date) %>
      <% main_material_delivery_date = @project.tasks.find_by(name: "資材納品")&.start_date %>
      <% box_tasks = box_tasks.to_a << Task.new(name: "化粧箱 - 資材納品", start_date: main_material_delivery_date) if main_material_delivery_date %> <!-- 資材納品タスクの追加 -->
      <% box_tasks.group_by { |task| task.start_date.year }.each do |year, tasks| %>
        <h4 class="year-heading"><%= year %>年</h4>
        <table class="task-table">
          <tbody>
            <% tasks.each do |task| %>
              <tr>
                <td><%= task.start_date.strftime("%-m/%-d") %></td>
                <td><%= task.name.gsub("化粧箱 - ", "") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      <div class="lead-time-box">
        <button class="lead-time-toggle">化粧箱のリードタイム</button>
        <div class="lead-time-container" style="display: none;">
          <table class="lead-time-table">
            <tbody>
              <tr><td>出稿 〜 青焼UP</td><td>14日</td></tr>
              <tr><td>青焼UP 〜 青焼校了</td><td>7日</td></tr>
              <tr><td>青焼校了 〜 試刷UP</td><td>14日</td></tr>
              <tr><td>試刷UP 〜 試刷校了</td><td>7日</td></tr>
              <tr><td>試刷校了 〜 資材納品</td><td>30日</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 追加スケジュールボックス -->
    <div class="schedule-box">
      <h3 class="centered-heading">追加スケジュール</h3>
      <% @project.tasks.where("name LIKE ?", "追加 - %").order(:start_date).group_by { |task| task.start_date.year }.each do |year, tasks| %>
        <h4 class="year-heading"><%= year %>年</h4>
        <table class="task-table">
          <tbody>
            <% tasks.each do |task| %>
              <tr>
                <td><%= task.start_date.strftime("%-m/%-d") %></td>
                <td><%= task.name.gsub("追加 - ", "") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      <div class="lead-time-box">
        <button class="lead-time-toggle">追加スケジュールのリードタイム</button>
        <div class="lead-time-container" style="display: none;">
          <table class="lead-time-table">
            <tbody>
              <tr><td>タスクA 〜 タスクB</td><td>10日</td></tr>
              <tr><td>タスクB 〜 タスクC</td><td>5日</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- スタイル -->
<style>
  .project-details { margin: 20px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
  .project-info p { margin: 8px 0; }
  .schedules-container { display: flex; justify-content: space-between; gap: 1%; }

  /* 各スケジュールボックス */
  .schedule-box {
    width: 30%; 
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 8px;
    background-color: #f4f4f4;
    margin-top: 15px;
  }

  /* 中央寄せの見出し */
  .centered-heading {
    text-align: center;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: bold;
  }

  /* タスクテーブル */
  .task-table { width: 100%; border-collapse: collapse; }
  .task-table td { padding: 2px; border: 1px solid #ddd; text-align: left; }
  .task-table td:first-child { width: 60px; }
  h4 { margin: 0; font-size: 1.1em; }

  /* リードタイムボタン */
  .lead-time-toggle { 
    margin-top: 8px;
    padding: 4px 8px;
    font-size: 1em;
    cursor: pointer;
    background-color: #4b615d;
    color: white;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
  }
  .lead-time-toggle:hover { background-color: #3e504d; }

  /* リードタイムテーブル */
  .lead-time-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .lead-time-table th, .lead-time-table td { padding: 2px; border: 1px solid #ddd; text-align: center; }
  .lead-time-table td:first-child { text-align: left; }
</style>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".lead-time-toggle").forEach(toggle => {
      toggle.addEventListener("click", function() {
        const container = this.nextElementSibling;
        container.style.display = container.style.display === "none" ? "block" : "none";
      });
    });
  });
</script>
